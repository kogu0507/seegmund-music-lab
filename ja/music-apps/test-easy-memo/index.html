<!DOCTYPE html>
<html lang="ja" data-i18n-page="template">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Seegmund Music Lab - 音楽理論、音楽アプリ、技術ノートなどのリソースを提供します。">
    <meta name="keywords" content="音楽アプリ, 音楽理論, 技術ノート, Seegmund Music Lab">
    <meta name="robots" content="index, follow">

    <title data-i18n="template.title">Seegmund music lab - test easy memo</title>
    <link rel="icon" href="/static/images/favicon.ico">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
</head>

<body class="bg-light">
    <header>
        <!-- 開発用なので、サイトヘッダーは削除。後で復元すること -->
    </header>

    <main class="container mt-4">
        <div class="preview-area container my-4 p-3 border bg-white">
            <h2>簡易メモ帳</h2>
            <div class="preview-content"></div>
            <div class="text-end mt-2">
                <small class="memo-char-count text-muted"></small>
            </div>
            <button class="btn btn-sm btn-primary mt-2 open-memo-modal">メモを編集</button>
            <button class="btn btn-sm btn-primary mt-2 easy-memo-copy">メモをコピー</button>
        </div>


        
        <div class="preview-area container my-4 p-3 border bg-white">
            <h2>簡易メモ帳</h2>
            <div class="preview-content"></div>
            <div class="text-end mt-2">
                <small class="memo-char-count text-muted"></small>
            </div>
            <button class="btn btn-sm btn-primary mt-2 open-memo-modal">メモを編集</button>
            <button class="btn btn-sm btn-primary mt-2 easy-memo-copy">メモをコピー</button>
        </div>

        <div class="container my-3 text-center">
            <h2>章末に設置するメモ用ボタンテスト</h2>
            <p>簡易メモに要点をまとめてみよう</p>
            <button class="btn btn-primary open-memo-modal">簡易メモ帳</button>
        </div>
    </main>

    <!-- サイトフッター -->
    <footer class="container py-4 border-top">
        <div class="container text-center">
            <button class="btn btn-primary open-memo-modal">簡易メモ帳</button>
        </div>

        <nav class="d-flex justify-content-between align-items-center flex-wrap mt-3">
            <ul class="list-unstyled mb-0 d-flex">
                <li class="me-3">
                    <a href="/ja/privacy-policy.html" class="text-decoration-none" aria-label="プライバシーポリシー"
                        data-i18n="common.footer.privacy_policy">プライバシーポリシー</a>
                </li>
                <li>
                    <a href="/ja/disclaimer.html" class="text-decoration-none" aria-label="免責事項"
                        data-i18n="common.footer.disclaimer">免責事項</a>
                </li>
            </ul>
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="langDropdown"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    Language
                </button>
                <ul class="dropdown-menu" aria-labelledby="langDropdown">
                    <li><a class="dropdown-item lang-switch" href="#" data-lang="en">English</a></li>
                    <li><a class="dropdown-item lang-switch" href="#" data-lang="ja">日本語</a></li>
                </ul>
            </div>
        </nav>

        <div class="text-center mt-3">
            <p class="mb-0" data-i18n="common.footer.copyright">© 2024 Seegmund music lab</p>
        </div>
    </footer>

    <!-- 簡易メモ帳 モーダル -->
    <div class="modal fade" id="easy-memo-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">簡易メモ帳</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- タブナビゲーション -->
                    <ul class="nav nav-tabs" id="memoTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="input-tab" data-bs-toggle="tab" data-bs-target="#input"
                                type="button" role="tab">入力</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview"
                                type="button" role="tab">プレビュー</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="guide-tab" data-bs-toggle="tab" data-bs-target="#guide"
                                type="button" role="tab">使い方</button>
                        </li>
                    </ul>

                    <!-- タブコンテンツ -->
                    <div class="tab-content mt-3" id="memoTabContent">
                        <!-- 入力タブ -->
                        <div class="tab-pane fade show active" id="input" role="tabpanel">
                            <textarea id="easy-memo-modal-input" class="form-control text-start" rows="5"
                                placeholder="メモを入力してください"></textarea>
                            <div class="text-end mt-2">
                                <small class="memo-char-count text-muted">0 / 50,000 文字</small>
                            </div>

                        </div>

                        <!-- プレビュータブ -->
                        <div class="tab-pane fade" id="preview" role="tabpanel">
                            <div class="easy-memo-modal-preview border p-3 bg-light text-start"></div>
                            <div class="text-end mt-2">
                                <small class="memo-char-count text-muted">0 / 50,000 文字</small>
                            </div>

                        </div>

                        <!-- 使い方タブ -->
                        <div class="tab-pane fade" id="guide" role="tabpanel">
                            <div class="p-3">
                                <h6>簡易メモ帳の使い方</h6>
                                <p>1. 「入力」タブでメモを入力してください。</p>
                                <p>2. 「プレビュー」タブでメモの見た目を確認できます。</p>
                                <p>3. メモは自動で保存されます。</p>
                                <p>4. 「メモをコピー」ボタンでメモをクリップボードにコピーできます。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-danger easy-memo-delete">メモを削除</button>
                    <button class="btn btn-primary easy-memo-copy">メモをコピー</button>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.10/purify.min.js"></script>
    <script type="module" src="/static/js/base.js"></script>


    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const memoModal = document.getElementById("easy-memo-modal");
            const modalTextarea = document.getElementById("easy-memo-modal-input");
            const previewAreas = document.querySelectorAll(".easy-memo-modal-preview");
            const topPreviews = document.querySelectorAll(".preview-content");
            const charCountElements = document.querySelectorAll(".memo-char-count");


            // ✅ 【定数化】メモの最大文字数（テスト用に10文字）
            const MAX_MEMO_LENGTH = 50;  // ⚠️ テスト後に 50000 に変更予定

            // ✅ 初回ロード時にカウンターの最大値を更新
            charCountElements.forEach(element => {
                element.textContent = `0 / ${MAX_MEMO_LENGTH} 文字`;
            });

            if (!memoModal) {
                console.error("モーダル要素が見つかりません。HTMLを確認してください。");
                return;
            }

            const memoInstance = new bootstrap.Modal(memoModal);

            // ============================================================
            // 関数
            // ============================================================
            // ✅ メモの保存
            function saveMemoToLocalStorage(content) {
                try {
                    if (content.length > MAX_MEMO_LENGTH) {
                        alert(`⚠️ メモが長すぎます！最大 ${MAX_MEMO_LENGTH} 文字までです。`);
                        return;
                    }

                    const sanitizedContent = DOMPurify.sanitize(content); // XSS対策
                    localStorage.setItem("memo", sanitizedContent);
                    updateCharCount(sanitizedContent);
                } catch (error) {
                    console.error("メモの保存に失敗しました:", error);
                    alert("メモの保存に失敗しました。ブラウザのストレージ設定を確認してください。");
                }
            }

            // ✅ 文字数を全ての表示エリアに更新する関数
            function updateCharCount(content) {
                const charCount = content.length;
                const warningThreshold = Math.floor(MAX_MEMO_LENGTH * 0.9); // 90% の閾値

                charCountElements.forEach(element => {
                    if (charCount >= MAX_MEMO_LENGTH) {
                        element.textContent = `⚠️ ${charCount} / ${MAX_MEMO_LENGTH} 文字 - 上限を超えています！`;
                        element.classList.remove("text-muted");
                        element.classList.add("text-danger");
                    } else if (charCount >= warningThreshold) {
                        element.textContent = `⚠️ ${charCount} / ${MAX_MEMO_LENGTH} 文字 - 上限が近づいています！`;
                        element.classList.remove("text-muted");
                        element.classList.add("text-danger");
                    } else {
                        element.textContent = `${charCount} / ${MAX_MEMO_LENGTH} 文字`;
                        element.classList.remove("text-danger");
                        element.classList.add("text-muted");
                    }
                });
            }



            // ✅ プレビュー更新関数
            function updatePreview(content) {
                const sanitizedContent = DOMPurify.sanitize(content);
                previewAreas.forEach(elem => {
                    elem.innerHTML = sanitizedContent;
                });
                topPreviews.forEach(elem => {
                    elem.innerHTML = sanitizedContent;
                });
            }

            // ✅ メモの読み込み
            function loadMemoFromLocalStorage() {
                try {
                    return localStorage.getItem("memo") || "";
                } catch (error) {
                    console.error("[Error] メモの読み込み失敗:", error);
                    alert("メモの読み込みに失敗しました。");
                    return "";
                }
            }

            // ✅ すべての「メモを開く」ボタンにイベントを設定
            document.querySelectorAll(".open-memo-modal").forEach(button => {
                button.addEventListener("click", () => {
                    memoInstance.show();
                });
            });

            // ✅ すべての .easy-memo-copy ボタンを取得し、コピー機能を追加
            document.querySelectorAll(".easy-memo-copy").forEach(button => {
                button.addEventListener("click", () => {
                    const memoContent = localStorage.getItem("memo") || "";
                    if (!memoContent) {
                        alert("コピーするメモがありません。");
                        return;
                    }

                    navigator.clipboard.writeText(memoContent)
                        .then(() => {
                            const originalClass = button.className;
                            button.textContent = "コピーしました！";
                            button.classList.remove("btn-primary");
                            button.classList.add("btn-success");

                            setTimeout(() => {
                                button.textContent = "メモをコピー";
                                button.className = originalClass;
                            }, 2000);
                        })
                        .catch(error => {
                            console.error("[Error] メモのコピー失敗:", error);
                            alert("メモのコピーに失敗しました。");
                        });
                });
            });

            // ✅ すべての .easy-memo-delete ボタンを取得し、削除機能を追加
            document.querySelectorAll(".easy-memo-delete").forEach(button => {
                button.addEventListener("click", () => {
                    if (confirm("本当にメモを削除しますか？この動作は元に戻せません。")) {
                        localStorage.removeItem("memo");
                        modalTextarea.value = "";
                        updatePreview("");
                        alert("メモを削除しました！");
                    }
                });
            });

            // 

            // ✅ 入力時に文字数を更新
            modalTextarea.addEventListener("input", () => {
                updateCharCount(modalTextarea.value);
            });

            // ✅ 自動保存 & プレビュー更新
            let saveTimer;
            modalTextarea.addEventListener("input", () => {
                clearTimeout(saveTimer);
                saveTimer = setTimeout(() => {
                    const content = modalTextarea.value;
                    saveMemoToLocalStorage(content);
                    updatePreview(content);
                }, 1000);
            });

            // ✅ 軽量なMarkdown変換関数（<br> のみ変換）
            /*
           function markdownToHtml(markdownText) {
               try {
                   return markdownText.replace(/\n/g, "<br>");
               } catch (error) {
                   console.error("[Error] Markdown変換に失敗しました:", error);
                   return "<p style='color: red;'>エラー: Markdownの変換に失敗しました。</p>";
               }
           }
           */

            // 初期ロード時のメモ設定
            const savedMemo = loadMemoFromLocalStorage();
            modalTextarea.value = savedMemo;
            updatePreview(savedMemo);
            updateCharCount(modalTextarea.value);
        });

    </script>
</body>

</html>