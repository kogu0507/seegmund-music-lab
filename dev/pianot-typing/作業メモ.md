# 作業メモ

## 概要

このドキュメントは、ピアノタイピングゲームの開発における残タスクをまとめたものです。各タスクの方針を明確にし、今後の開発をスムーズに進めることを目的とします。

## 残タスク一覧

### 1. GameDomManager.mjs の改善

**方針:** DOM 操作を担う `GameDomManager` の品質向上を図る。特に、エラー処理と初期化処理を強化する。

*   **1.1 コンストラクタの引数チェックの強化**
    *   **現状:** `domElements` の存在チェックのみ。
    *   **方針:** `domElements` の各プロパティ（`game-score-value` など）が実際に存在するかチェックを追加。
    *   **目的:** DOM 要素の取得失敗を早期に検出し、デバッグを容易にする。
*   **1.2 `update...` メソッドの引数チェックの強化**
    *   **現状:** 型チェックのみ。
    *   **方針:** 型チェックに加え、値の範囲チェックや不正な値が渡された場合の処理を追加（例：負の値が渡されたら 0 に丸める）。
    *   **目的:** 不正な値によるエラーを防ぎ、堅牢性を高める。
*   **1.3 `toggleElementVisibility` メソッドの改善**
    *   **現状:** `hide` と `show` の両方が指定されていない場合、何も処理が行われない。
    *   **方針:** `hide` または `show` のどちらかが必須になるように変更。引数の型チェックも追加。
    *   **目的:** メソッドの利用方法を明確化し、エラーを防ぐ。
*   **1.4 `reset` メソッドの完全化**
    *   **現状:** 一部の要素しか初期化されていない。
    *   **方針:** すべての DOM 要素を初期状態に戻すように変更。
    *   **目的:** ゲームの再スタート時に、DOM 要素が正しく初期化されることを保証する。
*   **1.5 `updateAllStatus` メソッドの実装**
    *   **現状:** コメントのみで未実装。
    *   **方針:** ゲームの状態が変化した際に、すべての DOM 要素を更新するために使用する。`updateScore`、`updateTimeLimit` などを呼び出すように実装。
    *   **目的:** ゲームの状態変化に合わせて、DOM を一括更新できるようにする。
*   **1.6 不要なコメントの削除**
    *   **現状:** `// TODO: ...` のコメントが多数残っている。
    *   **方針:** 実装が完了した TODO コメントは削除。実装しない TODO コメントは、本当に必要かどうかを検討し、不要であれば削除。
    *   **目的:** コードの可読性を高める。

### 2. GameCore.mjs の改善

**方針:** ゲームロジックを担う `GameCore` の各クラスの品質向上を図る。特に、エラー処理、設定管理、スコア管理、問題生成、タイマー、カウンターの各機能を強化する。

*   **2.1 StorageManager の実装**
    *   **現状:** `// TODO: ...` コメントのみで、ストレージへの保存・読み込み・削除・クリア処理が未実装。
    *   **方針:** `localStorage` を使用して、設定やハイスコアを保存・読み込み・削除・クリアできるように実装する。
    *   **目的:** ゲームの設定やハイスコアを永続化する。
*   **2.2 GameSettingsManager の改善**
    *   **現状:** 設定の適用、更新、リセット、保存処理が未完全。バリデーションも未完全。
    *   **方針:**
        *   設定が適用された際に、DOM を更新する処理を実装する。
        *   バリデーションに失敗した場合、エラーイベントを発行することを検討する。
        *   `StorageManager` を使用して、設定を保存・読み込みできるように実装する。
    *   **目的:** 設定機能を完全化し、エラー処理を強化する。
*   **2.3 GameScoreManager の改善**
    *   **現状:** スコア加算、減算、コンボ、ライフ管理、ハイスコア更新処理が未完全。
    *   **方針:**
        *   `correctCharCount` が数値であることをチェックする。
        *   スコアを減算する処理を実装する。
        *   減算するポイントが負の値でないことをチェックする。
        *   スコアが 0 未満にならないようにする。
        *   ライフが最大値を超えないようにする。
        *   正解数、不正解数の更新を通知するイベントを発行することを検討する。
        *   ハイスコアの更新は、ゲーム終了時に行う方が良いかもしれない。
        *   コンボボーナスを獲得したことを通知するイベントを発行することを検討する。
    *   **目的:** スコア管理機能を完全化し、エラー処理を強化する。
*   **2.4 GameQuestionGenerator の改善**
    *   **現状:** 問題生成ロジックが未完全。
    *   **方針:**
        *   `generateQuestions()` で、生成する問題の数を引数として指定できるようにする。
        *   他のゲームモードに対応するための準備をする。
        *   未知のゲームモードが指定された場合の処理を検討する。
        *   `_generateQuestionsMode2()`、`_generateQuestionsMode3()` のロジックを実装する。
        *   他のモードで使うことができる共通の処理は関数化する。
    *   **目的:** 問題生成機能を完全化し、拡張性を高める。
*   **2.5 GameTimeLimitTimer の改善**
    *   **現状:** タイマーの開始秒数、タイムリミット警告を発する秒数、タイムリミット終了を発する秒数などを設定できるようにする。
    *   **方針:**
        *   `options` に、タイマーの開始秒数、タイムリミット警告を発する秒数、タイムリミット終了を発する秒数などを設定できるようにする。
        *   `options` が指定されなかった場合の処理を検討する。
        *   `seconds`、`deltaSeconds` が不正な値だった場合のエラー処理を追加する。
        *   `updateTimer` の中で、`elapsedTime` と `seconds` の両方を更新しているが、実質的に同じ値を算出しているため、冗長である。どちらか一方を削除することを検討する。
        *   `reset()` の中で、`this.elapsedTime = 0;` が削除されているが、本当に不要かどうか、確認する。
    *   **目的:** タイマー機能を柔軟化し、エラー処理を強化する。
*   **2.6 GameCounter の改善**
    *   **現状:** カウンターのインクリメント、デクリメント、リセット処理が未完全。
    *   **方針:**
        *   `counterName` が不正な値だった場合のエラー処理を追加する。
        *   複数のカウンターをまとめてリセットするメソッドを追加する。
        *   ブラウザを閉じたときに、セッション系のカウンターをリセットする処理を追加する。（`window.onbeforeunload`）
        *   ブラウザを閉じたときに、永続化したいデータを保存する処理を追加する。（`window.onbeforeunload`）
        *   テストコードを追加する。
    *   **目的:** カウンター機能を完全化し、エラー処理を強化する。
*   **2.7 GameManager の改善**
    *   **現状:** ゲームの初期化、スタート、リプレイ処理が未完全。
    *   **方針:**
        *   `options` が指定されなかった場合のエラー処理を追加する。
        *   オプションをオブジェクトで渡すように修正する。
        *   メソッド名は統一感がある方がよい。「`handleReplayButtonClicked`」は、「`handleReplayButtonClick`」のように統一する。
        *   ゲームスタートの処理が整理されていないので、整理する。
        *   `start` 時に、再スタート時はすでに `audioContext` がある。という問題に注意する。
        *   `checkAnswer()` で、正誤判定を行い、`GameScoreManager` のメソッドを使ってスコアを更新する。
        *   `checkAnswer()` をリファクタリングする。
        *   `checkAnswer` するクラスは必要か検討する。わけておけばほかのゲームを作る時に差し替えだけとか？
    *   **目的:** ゲーム管理機能を完全化し、エラー処理を強化する。

### 3. EventBus.mjs の改善

**方針:** イベント名の一貫性と網羅性を高める。

*   **3.1 イベント名の見直し**
    *   **現状:** イベント名が適切か、重複していないか、わかりやすいか、多すぎないか、少なすぎないか、不足していないか、使われていないものがないか、使われすぎているものがないか、など、イベント名が適切かどうか、確認する必要がある。
    *   **方針:** イベント名が適切かどうか、網羅的に見直す。
    *   **目的:** イベント名の一貫性と網羅性を高め、コードの可読性と保守性を向上させる。

### 4. script.js の改善

**方針:** ゲーム全体の初期化処理とイベント処理を整理する。

*   **4.1 初期化処理の整理**
    *   **現状:** `gameManager.initialize();` がコメントアウトされている。
    *   **方針:** `GAME_INITIALIZED` イベントで初期化処理を行うように変更したので、不要なコメントアウトを削除する。
    *   **目的:** コードの可読性を高める。
*   **4.2 ゲームモード選択の通知**
    *   **現状:** 選択されたゲームモードを `GameSettingsManager` に通知する処理が未実装。
    *   **方針:** 選択されたゲームモードを `GameSettingsManager` に通知する処理を追加する。
    *   **目的:** ゲームモードの変更を `GameSettingsManager` に反映させる。
*   **4.3 ゲームモード変更時の再初期化**
    *   **現状:** `GameManager` にゲームモードが変更されたことを通知し、ゲームを再初期化する処理が未実装。
    *   **方針:** `GameManager` にゲームモードが変更されたことを通知し、ゲームを再初期化する処理を追加する。
    *   **目的:** ゲームモードの変更に合わせて、ゲームを再初期化する。
*   **4.4 イベント名の統一**
    *   **現状:** `GAME_EVENTS` に定義されているイベント名を使用するように統一されていない箇所がある。
    *   **方針:** `GAME_EVENTS` に定義されているイベント名を使用するように統一する。
    *   **目的:** イベント名の一貫性を高める。
*   **4.5 インスタンスの操作方法の検討**
    *   **現状:** `GameManager` がこれらのインスタンスを直接操作している箇所がある。
    *   **方針:** `GameManager` がこれらのインスタンスを直接操作する必要があるのか、それともイベントを通じて間接的に操作する方が良いのか、検討する。
    *   **目的:** モジュール間の結合度を低くする。
*   **4.6 GameDomManager のイベント購読の検討**
    *   **現状:** `GameDomManager` のイベントを購読して、処理を実行する必要があるのか、検討する必要がある。
    *   **方針:** `GameDomManager` のイベントを購読して、処理を実行する必要があるのか、検討する。
    *   **目的:** 不要なイベント購読を削除し、コードを整理する。
*   **4.7 エラー処理の追加**
    *   **現状:** エラー処理が不足している。
    *   **方針:** エラー処理を追加する。
    *   **目的:** エラー発生時に適切に処理できるようにする。
*   **4.8 デバッグ機能の追加**
    *   **現状:** デバッグ機能が不足している。
    *   **方針:** デバッグ機能を追加する。
    *   **目的:** デバッグを容易にする。
*   **4.9 テストコードの追加**
    *   **現状:** テストコードが不足している。
    *   **方針:** テストコードを追加する。
    *   **目的:** コードの品質を保証する。

## 補足

*   上記のタスクは、優先度や依存関係を考慮して、適切な順序で進める必要があります。
*   各タスクの完了後には、動作確認とテストを行う必要があります。
*   必要に応じて、タスクの追加や修正を行う必要があります。

