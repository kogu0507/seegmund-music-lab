<!DOCTYPE html>
<html lang="ja">

<head>
    <!-- Metaæƒ…å ±ã€SEOã€ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Seegmund Music Lab - éŸ³æ¥½ç†è«–ã€éŸ³æ¥½ã‚¢ãƒ—ãƒªã€æŠ€è¡“ãƒãƒ¼ãƒˆãªã©ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚">
    <meta name="keywords" content="éŸ³æ¥½ã‚¢ãƒ—ãƒª, éŸ³æ¥½ç†è«–, æŠ€è¡“ãƒãƒ¼ãƒˆ, Seegmund Music Lab">
    <meta name="robots" content="index, follow">

    <title>Seegmund Music Lab - æ—¥æœ¬èªç‰ˆ</title>
    <link rel="icon" href="/static/images/favicon.ico">
    <link rel="alternate" href="https://seegmund-music-lab.com/en/" hreflang="en" />
    <link rel="alternate" href="https://seegmund-music-lab.com/ja/" hreflang="ja" />

    <!-- Bootstrap CSS ã¨ Bootstrap Icons ã®èª­ã¿è¾¼ã¿ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

</head>

<body class="bg-light">

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠé–‹å§‹ -->
    <main class="container mt-4">
        <!-- æ¥½è­œé¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="mt-3">
            <label for="scoreSelect" class="form-label">æ¥½è­œã‚’é¸æŠ:</label>
            <select id="scoreSelect" class="form-select">
                <option value="sample1">é€šå¥ï¼š1-8å°ç¯€</option>
                <option value="sample2">å‰åŠï¼š1-4å°ç¯€</option>
                <option value="exam">è©¦é¨“</option>
            </select>
        </div>

        <!-- ã‚½ãƒ—ãƒ©ãƒã®æ¥½å™¨é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="mt-3">
            <label for="sopranoInstrument" class="form-label">ã‚½ãƒ—ãƒ©ãƒã®æ¥½å™¨:</label>
            <select id="sopranoInstrument" class="form-select">
                <option value="piano">ãƒ”ã‚¢ãƒ</option>
                <option value="synth" disabled>ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼ [comming soon]</option>
            </select>
        </div>

        <!-- ãƒã‚¹ã®æ¥½å™¨é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="mt-3">
            <label for="bassInstrument" class="form-label">ãƒã‚¹ã®æ¥½å™¨:</label>
            <select id="bassInstrument" class="form-select">
                <option value="piano">ãƒ”ã‚¢ãƒ</option>
                <option value="synth" disabled>ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼ [comming soon]</option>
            </select>
        </div>

        <!-- BPMï¼ˆãƒ†ãƒ³ãƒï¼‰å¤‰æ›´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="mt-3">
            <label for="bpmControl" class="form-label">BPMï¼ˆãƒ†ãƒ³ãƒï¼‰:</label>
            <input type="range" id="bpmControl" class="form-range" min="40" max="240" value="80">
            <input type="number" id="bpmValue" class="form-control mt-2" min="40" max="240" value="80">
        </div>

        <!-- éŸ³é‡å¤‰æ›´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="mt-3">
            <label for="volumeControl" class="form-label">éŸ³é‡ï¼ˆdBï¼‰:</label>
            <input type="range" id="volumeControl" class="form-range" min="-60" max="6" value="0">
            <input type="number" id="volumeValue" class="form-control mt-2" min="-60" max="6" value="0">
        </div>

        <!-- ç§»èª¿ï¼ˆã‚­ãƒ¼å¤‰æ›´ï¼‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="mt-3">
            <label for="transposeControl" class="form-label">ç§»èª¿ï¼ˆåŠéŸ³å˜ä½ï¼‰:</label>
            <select id="transposeControl" class="form-select">
                <option value="-12">-12 åŠéŸ³ï¼ˆ1ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸‹ï¼‰</option>
                <option value="-11">-11 åŠéŸ³</option>
                <option value="-10">-10 åŠéŸ³</option>
                <option value="-9">-9 åŠéŸ³</option>
                <option value="-8">-8 åŠéŸ³</option>
                <option value="-7">-7 åŠéŸ³</option>
                <option value="-6">-6 åŠéŸ³</option>
                <option value="-5">-5 åŠéŸ³</option>
                <option value="-4">-4 åŠéŸ³</option>
                <option value="-3">-3 åŠéŸ³</option>
                <option value="-2">-2 åŠéŸ³</option>
                <option value="-1">-1 åŠéŸ³</option>
                <option value="0" selected>Â±0ï¼ˆå…ƒã®ã‚­ãƒ¼ï¼‰</option>
                <option value="1">+1 åŠéŸ³</option>
                <option value="2">+2 åŠéŸ³</option>
                <option value="3">+3 åŠéŸ³</option>
                <option value="4">+4 åŠéŸ³</option>
                <option value="5">+5 åŠéŸ³</option>
                <option value="6">+6 åŠéŸ³</option>
                <option value="7">+7 åŠéŸ³</option>
                <option value="8">+8 åŠéŸ³</option>
                <option value="9">+9 åŠéŸ³</option>
                <option value="10">+10 åŠéŸ³</option>
                <option value="11">+11 åŠéŸ³</option>
                <option value="12">+12 åŠéŸ³ï¼ˆ1ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸Šï¼‰</option>
            </select>
        </div>

        <!-- ãƒ«ãƒ¼ãƒ—å†ç”ŸON/OFFã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-check mt-3">
            <input type="checkbox" class="form-check-input" id="loopControl" disabled>
            <label class="form-check-label" for="loopControl">ãƒ«ãƒ¼ãƒ—å†ç”Ÿ</label>
            <span class="text-secondary">comming soon</span>
        </div>


        <!-- å†ç”Ÿã¨åœæ­¢ãƒœã‚¿ãƒ³ -->
        <div class="mt-3">
            <button type="button" id="startBtn" class="btn btn-primary disabled">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <button type="button" id="stopBtn" class="btn btn-danger disabled">ã‚¹ãƒˆãƒƒãƒ—</button>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
        <div class="fixed-bottom bg-light p-2 border-top">
            <div class="container">
                <span id="statusText">æº–å‚™ã‚’é–‹å§‹ã—ã¾ã™...</span>
            </div>
        </div>
    </main>

    <!-- Bootstrapã®JavaScriptãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- ãƒ¡ã‚¤ãƒ³ã®JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆdeferå±æ€§ã«ã‚ˆã‚Šå¾Œã§å®Ÿè¡Œï¼‰ -->
    <script type="module" src="/static/js/base.js" defer></script>

    <!-- Tone.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.1.3/Tone.js"></script>



    <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸»è¦ãªãƒ­ã‚¸ãƒƒã‚¯ -->
    <script type="module">
        // ==================================================
        // åˆæœŸè¨­å®šã¨TODOãƒªã‚¹ãƒˆ
        // ==================================================
        /*
         
        */
        // ==================================================
        // 1. å¤–éƒ¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        // ==================================================
        import { validateSchema } from "/static/js/validation.js";

        // ==================================================
        // 2. å®šæ•°ã¨UIè¦ç´ ã®å–å¾—
        // ==================================================
        // å„ç¨®UIã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
        const ids = [
            'startBtn',
            'stopBtn',
            'sopranoInstrument',
            'bassInstrument',
            'bpmControl',
            'bpmValue',
            'volumeControl',
            'volumeValue',
            'transposeControl',
            'loopControl',
            'scoreSelect',
            'statusText'
        ];
        const elements = getElementsByIds(ids);

        // ã‚¤ãƒ™ãƒ³ãƒˆ
        const EVENT_PLAY = "play";
        const EVENT_STOP = "stop";
        const EVENT_INSTRUMENT_CHANGE = "instrumentChange";

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const STATUS_MSG_ERROR = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
        const STATUS_MSG_PREPARING = "æº–å‚™ä¸­...";
        const STATUS_MSG_READY = "æº–å‚™å®Œäº†";
        const STATUS_MSG_PLAYING = "å†ç”Ÿä¸­...";
        const STATUS_MSG_STOPPED = "åœæ­¢ä¸­";

        // ==================================================
        // 3. UIã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        // ==================================================
        document.addEventListener('DOMContentLoaded', function () {
            /*  // BPMå¤‰æ›´: ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨æ•°å€¤å…¥åŠ›ã‚’åŒæœŸã—ã€ãƒ†ãƒ³ãƒæ›´æ–°ã‚’åæ˜ 
            bpmControl.addEventListener("input", () => {
                bpmValue.value = bpmControl.value;
                multiPlayer.setTempo(parseInt(bpmControl.value, 10));
            });
            bpmValue.addEventListener("input", () => {
                bpmControl.value = bpmValue.value;
                multiPlayer.setTempo(parseInt(bpmValue.value, 10));
            });

            // éŸ³é‡å¤‰æ›´: ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨æ•°å€¤å…¥åŠ›ã‚’åŒæœŸã—ã€éŸ³é‡æ›´æ–°ã‚’åæ˜ 
            volumeControl.addEventListener("input", () => {
                volumeValue.value = volumeControl.value;
                multiPlayer.setVolume(parseInt(volumeControl.value, 10));
            });
            volumeValue.addEventListener("input", () => {
                volumeControl.value = volumeValue.value;
                multiPlayer.setVolume(parseInt(volumeValue.value, 10));
            });  
            */
            /**
             * ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¾ãŸã¯æ•°å€¤å…¥åŠ›ã®å¤‰æ›´ã‚’å‡¦ç†ã™ã‚‹å…±é€šé–¢æ•°
             * @param {HTMLElement} element å¤‰æ›´ã•ã‚ŒãŸè¦ç´ ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¾ãŸã¯æ•°å€¤å…¥åŠ›ï¼‰
             * @param {Function} setter multiPlayerã®å€¤ã‚’è¨­å®šã™ã‚‹é–¢æ•° (setTempo, setVolumeãªã©)
             */
            function handleControlChange(element, setter) {
                // è¦ç´ ã®å€¤ã‚’æ•´æ•°ã«å¤‰æ›
                const value = parseInt(element.value, 10);
                // setteré–¢æ•°ã‚’ä½¿ã£ã¦multiPlayerã®å€¤ã‚’æ›´æ–°
                setter(value);
            }

            // BPMã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
            bpmControl.addEventListener("input", () => {
                // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’multiPlayerã«è¨­å®š
                handleControlChange(bpmControl, multiPlayer.setTempo.bind(multiPlayer));
                // æ•°å€¤å…¥åŠ›ã‚’ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã«åŒæœŸ
                bpmValue.value = bpmControl.value;
            });

            bpmValue.addEventListener("input", () => {
                // æ•°å€¤å…¥åŠ›ã®å€¤ã‚’multiPlayerã«è¨­å®š
                handleControlChange(bpmValue, multiPlayer.setTempo.bind(multiPlayer));
                // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’æ•°å€¤å…¥åŠ›ã®å€¤ã«åŒæœŸ
                bpmControl.value = bpmValue.value;
            });

            // éŸ³é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
            volumeControl.addEventListener("input", () => {
                // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’multiPlayerã«è¨­å®š
                handleControlChange(volumeControl, multiPlayer.setVolume.bind(multiPlayer));
                // æ•°å€¤å…¥åŠ›ã‚’ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã«åŒæœŸ
                volumeValue.value = volumeControl.value;
            });

            volumeValue.addEventListener("input", () => {
                // æ•°å€¤å…¥åŠ›ã®å€¤ã‚’multiPlayerã«è¨­å®š
                handleControlChange(volumeValue, multiPlayer.setVolume.bind(multiPlayer));
                // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’æ•°å€¤å…¥åŠ›ã®å€¤ã«åŒæœŸ
                volumeControl.value = volumeValue.value;
            });

            //----------

            // ç§»èª¿å¤‰æ›´: ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§é¸æŠã•ã‚ŒãŸåŠéŸ³æ•°ã‚’è¨­å®š
            transposeControl.addEventListener("change", () => {
                multiPlayer.setTranspose(parseInt(transposeControl.value, 10));
            });

            // ãƒ«ãƒ¼ãƒ—å†ç”ŸON/OFF: ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’åæ˜ 
            loopControl.addEventListener("change", () => {
                multiPlayer.setLoop(loopControl.checked);
            });

            startBtn.addEventListener("click", async () => {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ AudioContext ã‚’å†é–‹
                await Tone.start();
                // å¿µã®ãŸã‚ã€AudioContext ã‚’æ˜ç¤ºçš„ã«å†é–‹
                await Tone.context.resume();
                console.log("AudioContext is running:", Tone.context.state);

                if (!multiPlayer.checkPlayers()) {
                    return; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æº–å‚™ãŒã§ãã¦ã„ãªã‘ã‚Œã°ä¸­æ­¢
                }

                console.log("â–¶ï¸ å†ç”Ÿé–‹å§‹: ", scoreSelect.value);
                multiPlayer.start();
            });


            // åœæ­¢ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            stopBtn.addEventListener("click", () => {
                multiPlayer.stop();
                console.log("â¹ï¸ åœæ­¢ã—ã¾ã—ãŸ");
                togglePlayButtons(true);
            });
        });

        // ==================================================
        // 4. Playerã‚¯ãƒ©ã‚¹ã¨MultiPlayerã‚¯ãƒ©ã‚¹ã®å®šç¾©
        // ==================================================

        /**
         * Playerã‚¯ãƒ©ã‚¹
         * å˜ä¸€ã®éŸ³æ¥½ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦æ¥½å™¨ã€ã‚¹ã‚³ã‚¢ã€å†ç”Ÿãƒ»åœæ­¢ãªã©ã‚’ç®¡ç†
         */
        class Player extends EventTarget {
            constructor() {
                super();
                // åˆ©ç”¨å¯èƒ½ãªæ¥½å™¨ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚„å„ç¨®è¨­å®š
                this.instruments = {};
                this.currentInstrumentKey = 'piano';
                this.score = null;      // Tone.js ç”¨ã«å¤‰æ›æ¸ˆã¿ã®ã‚¹ã‚³ã‚¢
                this.rawScore = null;   // ç”Ÿã®ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ï¼ˆå†è¨ˆç®—ç”¨ï¼‰
                this.isPlaying = false; // å†ç”ŸçŠ¶æ…‹
                this.sequence = null;   // Tone.Part ã®ä¿æŒ
                this.loop = false;      // ãƒ«ãƒ¼ãƒ—å†ç”Ÿãƒ•ãƒ©ã‚°
                this.volume = new Tone.Volume(0).toDestination();
                this.tempo = 120;       // BPM
                this.transpose = 0;     // ç§»èª¿ï¼ˆåŠéŸ³ï¼‰
                //this.id = id;
                this.samplerInitialized = false; // åˆæœŸå€¤ã¯æœªåˆæœŸåŒ–
                this.scoreSet = false; // åˆæœŸå€¤ã¯æ¥½è­œæœªã‚»ãƒƒãƒˆ

                // åˆæœŸåŒ–ï¼ˆä¾‹ï¼šã‚µãƒ³ãƒ—ãƒ©ãƒ¼ã®åˆæœŸåŒ–ï¼‰
                this.initializeSampler("piano");
            }

            /**
             * ã‚·ãƒ³ã‚»ã®åˆæœŸåŒ–
             * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚·ãƒ³ã‚»ã‚’ä½œæˆã—ã€æ¥½å™¨ã¨ã—ã¦è¨­å®šã™ã‚‹
             */
            async initializeSynth() {
                // InstrumentDataStore ã‹ã‚‰ "synth" ã®æ¥½å™¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const instrumentData = instrumentStore.getInstrument("synth");
                if (!instrumentData) {
                    console.error("ğŸ”´ Synth ã®æ¥½å™¨ãƒ‡ãƒ¼ã‚¿ãŒ instrumentStore ã«å­˜åœ¨ã—ã¾ã›ã‚“", " ( class: Player )");
                    return;
                }
                // instrumentStore çµŒç”±ã§ã‚·ãƒ³ã‚»ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã‚Œã°å†åˆ©ç”¨ã•ã‚Œã‚‹ï¼‰
                const synth = await instrumentStore.loadInstrument("synth");
                // Player ã® instruments ã«ã‚·ãƒ³ã‚»ã‚’ç™»éŒ²ã—ã€æ¥½å™¨ã‚’ã‚»ãƒƒãƒˆ
                this.instruments.synth = synth;
                this.setInstrument("synth");
                console.log("ğŸ”¹ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚·ãƒ³ã‚»ãŒ instrumentStore ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€ã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ", " ( class: Player )");
            }


            /**
             * ã‚µãƒ³ãƒ—ãƒ©ãƒ¼ã®åˆæœŸåŒ–
             * æŒ‡å®šã•ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ©ãƒ¼éŸ³æºã‚’éåŒæœŸã«ãƒ­ãƒ¼ãƒ‰ã—ã€æ¥½å™¨ã¨ã—ã¦è¨­å®šã™ã‚‹
             * @param {string} key - æ¥½å™¨ã‚­ãƒ¼
             * @param {object} urls - ã‚µãƒ³ãƒ—ãƒ«éŸ³æºã®URLãƒãƒƒãƒ”ãƒ³ã‚°
             * @param {string} baseUrl - ã‚µãƒ³ãƒ—ãƒ«éŸ³æºã®åŸºæœ¬URL
             */
            async initializeSampler(key) { //, urls, baseUrl) {
                if (this.instruments[key]) {
                    console.log(`ğŸ¹ ${key} ã¯ã™ã§ã«ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã§ã™`, " ( class: Player )");
                    this.setInstrument(key);
                    return;
                }

                const instrumentData = instrumentStore.getInstrument(key); // instrumentStoreã‹ã‚‰æ¥½å™¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                if (!instrumentData) {
                    console.error(`ğŸ”´ ${key} ã®æ¥½å™¨ãƒ‡ãƒ¼ã‚¿ãŒ instrumentStore ã«å­˜åœ¨ã—ã¾ã›ã‚“`, " ( class: Player )");
                    return;
                }

                return new Promise((resolve, reject) => {
                    const sampler = new Tone.Sampler({
                        urls: instrumentData.samples,
                        baseUrl: instrumentData.baseUrl,
                        onload: () => {
                            this.instruments[key] = sampler;
                            console.log(`ğŸ¹ ã‚µãƒ³ãƒ—ãƒ©ãƒ¼ (${key}) ãŒæ­£å¸¸ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ`, " ( class: Player )");
                            this.samplerInitialized = true;
                            this.setInstrument(key);
                            togglePlayButtons(true);
                            resolve();
                        },
                        onerror: (error) => {
                            console.error(`âš ï¸ ã‚µãƒ³ãƒ—ãƒ©ãƒ¼ (${key}) ã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ:`, error, " ( class: Player )");
                            console.warn("ğŸ”„ ä»£æ›¿ã¨ã—ã¦ã‚·ãƒ³ã‚»ã‚’ä½¿ç”¨ã—ã¾ã™...", " ( class: Player )");
                            this.initializeSynth().then(resolve).catch(reject);
                        }
                    }).toDestination();
                });

            }

            /**
             * æ¥½å™¨ã®åˆ‡ã‚Šæ›¿ãˆ
             * æŒ‡å®šã—ãŸæ¥½å™¨ã‚­ãƒ¼ã«åŸºã¥ã„ã¦ç¾åœ¨ã®æ¥½å™¨ã‚’æ›´æ–°ã™ã‚‹
             * @param {string} instrumentKey 
             */
            setInstrument(instrumentKey) {
                if (!this.instruments[instrumentKey]) {
                    console.error(`âš ï¸ æ¥½å™¨ (${instrumentKey}) ã¯ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“`, " ( class: Player )");
                    return;
                }
                this.currentInstrumentKey = instrumentKey;
                this.instrument = this.instruments[instrumentKey]; // ç¾åœ¨ä½¿ç”¨ã™ã‚‹æ¥½å™¨ã‚’è¨­å®š
                console.log(`ğŸµ æ¥½å™¨ã‚’ ${instrumentKey} ã«è¨­å®šã—ã¾ã—ãŸ`, " ( class: Player )");
                // æ¥½å™¨å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
                this.dispatchEvent(new Event(EVENT_INSTRUMENT_CHANGE));
            }

            /**
             * æ¥½è­œãƒ‡ãƒ¼ã‚¿ã®è¨­å®š
             * æŒ‡å®šã•ã‚ŒãŸãƒ‘ãƒ¼ãƒˆã®æ¥½è­œãƒ‡ãƒ¼ã‚¿ã‚’ Tone.js ç”¨å½¢å¼ã«å¤‰æ›ã—ã¦ä¿å­˜ã™ã‚‹
             * @param {object} scoreData - æ¥½è­œãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
             * @param {number} partIndex - å¯¾è±¡ãƒ‘ãƒ¼ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
             */
            setScore(scoreData, partIndex = 0) {
                if (!scoreData || !scoreData.parts || !Array.isArray(scoreData.parts)) {
                    console.error("âš ï¸ ç„¡åŠ¹ãªã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿: `parts` ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", " ( class: Player )");
                    return;
                }

                const part = scoreData.parts[partIndex];
                if (!part || !Array.isArray(part.notes)) {
                    console.error(`âš ï¸ ç„¡åŠ¹ãªã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿: partIndex=${partIndex} ã® notes ãŒå­˜åœ¨ã—ã¾ã›ã‚“`, " ( class: Player )");
                    return;
                }

                // ç”Ÿãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜ï¼ˆå†è¨ˆç®—ç”¨ã«ä¿æŒï¼‰
                this.rawScore = part.notes;

                // æ¥½è­œãƒ‡ãƒ¼ã‚¿ã‚’ Tone.js ç”¨ã«å¤‰æ›ï¼ˆã“ã®ã¨ã this.tempo ã‚’åˆ©ç”¨ï¼‰
                this.score = this.rawScore.map(note => ({
                    time: note.absoluteBeat / (this.tempo / 60),
                    note: note.pitch,
                    duration: (note.duration / 480) * (60 / this.tempo)
                }));
                this.scoreSet = true;

                //console.log("å¤‰æ›å¾Œã®ã‚¹ã‚³ã‚¢:", this.score);
                console.log(`ğŸ¼ Player ${partIndex + 1} ã«ã‚¹ã‚³ã‚¢ã‚’è¨­å®šã—ã¾ã—ãŸ`, " ( class: Player )");
            }

            isSamplerInitialized() {
                return this.samplerInitialized;
            }

            isScoreSet() {
                return this.scoreSet;
            }


            /**
             * ãƒ†ãƒ³ãƒã®è¨­å®š
             * Tone.Transport ã® BPM å€¤ã‚’æ›´æ–°ã—ã€å¿…è¦ã«å¿œã˜ã¦ã‚¹ã‚³ã‚¢ã®å†è¨ˆç®—ã‚’è¡Œã†
             * @param {number} bpm 
             */
            setTempo(bpm) {
                if (typeof bpm === "number" && bpm > 0) {
                    this.tempo = bpm;
                    Tone.Transport.bpm.value = bpm;
                    console.log(`ğŸµ ãƒ†ãƒ³ãƒã‚’ ${bpm} BPM ã«è¨­å®šã—ã¾ã—ãŸ`, " ( class: Player )");

                    // ã‚‚ã—ç”Ÿãƒ‡ãƒ¼ã‚¿ (this.rawScore) ãŒå­˜åœ¨ã™ã‚Œã°ã€å†è¨ˆç®—ã™ã‚‹
                    if (this.rawScore) {
                        this.score = this.rawScore.map(note => ({
                            time: note.absoluteBeat / (this.tempo / 60),
                            note: note.pitch,
                            duration: (note.duration / 480) * (60 / this.tempo)
                        }));
                        console.log("å†è¨ˆç®—å¾Œã®ã‚¹ã‚³ã‚¢:", this.score, " ( class: Player )");
                    }
                } else {
                    console.error("âš ï¸ ç„¡åŠ¹ãª BPM ã®å€¤", " ( class: Player )");
                }
            }

            /**
             * éŸ³é‡ã®è¨­å®š
             * Tone.js ã® Volume ãƒãƒ¼ãƒ‰ã®å€¤ã‚’æ›´æ–°ã™ã‚‹
             * @param {number} value - dB å˜ä½ã®éŸ³é‡
             */
            setVolume(value) {
                if (typeof value === "number" && value >= -60 && value <= 6) {
                    this.volume.volume.value = value;
                    console.log(`ğŸ”Š éŸ³é‡ã‚’ ${value} dB ã«è¨­å®šã—ã¾ã—ãŸ`, " ( class: Player )");
                } else {
                    console.error("âš ï¸ ç„¡åŠ¹ãªéŸ³é‡å€¤ï¼ˆç¯„å›²: -60dB ï½ 6dBï¼‰", " ( class: Player )");
                }
            }

            /**
             * ãƒ«ãƒ¼ãƒ—å†ç”Ÿã®æœ‰åŠ¹åŒ–
             * @param {boolean} loop - ãƒ«ãƒ¼ãƒ—å†ç”Ÿã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‹
             */
            enableLoop(loop) {
                this.loop = !!loop;
                console.log(`ğŸ”„ ãƒ«ãƒ¼ãƒ—å†ç”Ÿ: ${this.loop ? "ON" : "OFF"}`, " ( class: Player )");
            }

            /**
             * ç§»èª¿ã®è¨­å®š
             * æ¼”å¥æ™‚ã«å„éŸ³ç¬¦ã‚’æŒ‡å®šã—ãŸåŠéŸ³æ•°ã ã‘ã‚·ãƒ•ãƒˆã™ã‚‹
             * @param {number} semitones 
             */
            setTranspose(semitones) {
                if (typeof semitones === "number") {
                    this.transpose = semitones;
                    console.log(`ğŸ¼ ç§»èª¿: ${semitones} åŠéŸ³`, " ( class: Player )");
                } else {
                    console.error("âš ï¸ ç„¡åŠ¹ãªç§»èª¿å€¤", " ( class: Player )");
                }
            }

            /**
             * æ¼”å¥ã®é–‹å§‹
             * â€» Tone.Transport ã®é–‹å§‹ã¯è¡Œã‚ãšã€Tone.Part ã®æº–å‚™ã ã‘ã‚’è¡Œã†
             */
            start() {
                if (!this.instrument) {
                    if (this.instruments[this.currentInstrumentKey]) {
                        this.instrument = this.instruments[this.currentInstrumentKey];
                    } else {
                        throw new Error("âŒ æ¥½å™¨ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“", " ( class: Player )");
                    }
                }

                if (!this.score) {
                    throw new Error("âŒ æ¥½è­œãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“", " ( class: Player )");
                }
                if (this.isPlaying) return;
                // ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã®æº–å‚™ï¼ˆTone.Part ã®ç”Ÿæˆï¼‰
                this.prepareSequence();
                this.isPlaying = true;
            }

            /**
             * æ¼”å¥ã®åœæ­¢
             * â€» Tone.Transport ã®åœæ­¢ã¯è¡Œã‚ãšã€Tone.Part ã®åœæ­¢ãƒ»ç ´æ£„ã®ã¿ã‚’è¡Œã†
             */
            stop() {
                if (!this.isPlaying) return;

                if (this.sequence) {
                    // ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ï¼ˆTone.Partï¼‰ã®åœæ­¢ã¨ç ´æ£„
                    this.sequence.stop();
                    this.sequence.dispose();
                    this.sequence = null;
                }

                Tone.Transport.stop();
                this.isPlaying = false;
            }

            /**
             * ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã®æº–å‚™
             * ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ Tone.Part ã‚’ä½œæˆã—ã€å„éŸ³ç¬¦ã®ç™ºéŸ³ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ç™»éŒ²ã™ã‚‹
             * â€»åœæ­¢ã‚¿ã‚¤ãƒãƒ¼ã®è¨­å®šã¯è¡Œã‚ãªã„
             */
            prepareSequence() {
                if (!this.score) {
                    console.error("âš ï¸ ã‚¹ã‚³ã‚¢ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“", " ( class: Player )");
                    return;
                }

                // Tone.Part ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’ä½œæˆ
                const events = this.score.map(note => [note.time, note]);
                console.log("Tone.Part ã«æ¸¡ã™ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆ:", events, " ( class: Player )");
                // Tone.Part ã‚’ä½œæˆã—ã€0æ™‚ç‚¹ã‹ã‚‰é–‹å§‹
                this.sequence = new Tone.Part((time, event) => {
                    // ç§»èª¿ã‚’é©ç”¨ã—ãŸéŸ³ç¨‹ã«å¤‰æ›ã—ã¦ç™ºéŸ³
                    const transposedNote = Tone.Frequency(event.note).transpose(this.transpose).toNote();
                    this.instrument.triggerAttackRelease(transposedNote, event.duration, time);
                }, events).start(0);

                // ãƒ«ãƒ¼ãƒ—å†ç”Ÿè¨­å®šã¯ Player å†…ã§è¡Œã†ãŒã€Tone.Transport.loop ã®è¨­å®šã¯ MultiPlayer ã«ä»»ã›ã‚‹
                // â€»ã“ã“ã§ã¯ã€ãƒ«ãƒ¼ãƒ—ãƒ•ãƒ©ã‚°ã®çŠ¶æ…‹ã«å¿œã˜ã¦ Tone.Part è‡ªä½“ã®ãƒ«ãƒ¼ãƒ—è¨­å®šã¯å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã§ãã¾ã™


            }
            /**
            * è‡ªåˆ†ã®æ¥½è­œã®æ¼”å¥æ™‚é–“ã‚’è¨ˆç®—
            * æœ€å¾Œã®ãƒãƒ¼ãƒˆã®çµ‚äº†æ™‚åˆ»ï¼ˆabsoluteBeat + durationï¼‰ã‚’æ±‚ã‚ã¾ã™
            * @returns {number} - æ¼”å¥æ™‚é–“ï¼ˆç§’ï¼‰
            */
            getPerformanceTime() {
                if (!this.score || this.score.length === 0) {
                    console.warn("âš ï¸ æ¥½è­œãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“", " ( class: Player )");
                    return 0;
                }

                const lastNote = this.score[this.score.length - 1];
                const endTimeInBeats = lastNote.absoluteBeat + lastNote.duration; // æ‹å˜ä½ã§ã®çµ‚äº†æ™‚åˆ»

                // BPMã‚’å–å¾—
                const bpm = this.score.meta.bpm;

                // ç§’å˜ä½ã«å¤‰æ›
                const endTimeInSeconds = endTimeInBeats / (bpm / 60);

                return endTimeInSeconds;
            }

        }

        /**
         * MultiPlayerã‚¯ãƒ©ã‚¹
         * è¤‡æ•°ã® Player ã‚’ç®¡ç†ã—ã€Tone.Transport ã®é–‹å§‹ï¼åœæ­¢ã‚„åœæ­¢ã‚¿ã‚¤ãƒãƒ¼ã®è¨­å®šã‚’ä¸€å…ƒç®¡ç†ã™ã‚‹
         */
        class MultiPlayer extends EventTarget {
            constructor() {
                super();
                this.players = []; // è¤‡æ•°ã® Player ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒ
            }

            /**
             * Player ã®è¿½åŠ 
             */
            addPlayer(player) {
                if (!(player instanceof Player)) {
                    console.error("âš ï¸ `Player` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã¿è¿½åŠ å¯èƒ½ã§ã™", " ( class: MultiPlayer )");
                    return;
                }
                this.players.push(player);
                console.log(`ğŸµ Player ã‚’è¿½åŠ ã—ã¾ã—ãŸ (ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: ${this.players.length})`, " ( class: MultiPlayer )");
            }

            /**
             * Player ã®å‰Šé™¤
             * @param {Player} player - å‰Šé™¤ã™ã‚‹ Player ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
             */
            removePlayer(player) {
                this.players = this.players.filter(p => p !== player);
                console.log(`ğŸ—‘ Player ã‚’å‰Šé™¤ã—ã¾ã—ãŸ (ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: ${this.players.length})`, " ( class: MultiPlayer )");
            }

            /**
             * ç¾åœ¨ã® Player ä¸€è¦§ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å–å¾—
             * @returns {Array<Object>} - Player ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
             */
            getPlayersWithStatus() {
                return this.players.map(player => ({
                    player: player, // Player ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
                    status: {
                        samplerInitialized: player.isSamplerInitialized(),
                        scoreSet: player.isScoreSet(),
                        // ä»–ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ã‚‚ã“ã“ã«è¿½åŠ å¯èƒ½
                    }
                }));
            }
            getPlayerStatusAll() {
                /*  TODO:
                    getPlayerStatusAll() ã®æˆ»ã‚Šå€¤ã¯ã€é…åˆ—å½¢å¼ã§ã‚‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã§ã‚‚ã©ã¡ã‚‰ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚ã©ã¡ã‚‰ã‚’é¸ã¶ã‹ã¯ã€å®Ÿéš›ã«ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã©ã®ã‚ˆã†ã«ä½¿ã†ã‹ã«ã‚ˆã£ã¦æ±ºã¾ã‚Šã¾ã™ã€‚

                    é…åˆ—å½¢å¼: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é †åºãŒé‡è¦ãªå ´åˆã‚„ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„å ´åˆã«ä¾¿åˆ©ã§ã™ã€‚
                    ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åå‰ï¼ˆä¾‹ãˆã° "player1"ï¼‰ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„å ´åˆã«ä¾¿åˆ©ã§ã™ã€‚
                    ã‚‚ã—ç‰¹ã«ç†ç”±ãŒãªã‘ã‚Œã°ã€é…åˆ—å½¢å¼ã§è¿”ã™æ–¹ãŒã‚·ãƒ³ãƒ—ãƒ«ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
                      */
                return this.players.map(player => this.getPlayerStatus(player));
                // ã¾ãŸã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã§è¿”ã™å ´åˆ
                // const allStatus = {};
                // this.players.forEach((player, index) => {
                //   allStatus[`player${index + 1}`] = this.getPlayerStatus(player);
                // });
                // return allStatus;
            }

            isReady() {
                return this.players.every(player => player.isSamplerInitialized() && player.isScoreSet());
            }

            checkPlayer(player) { // 1äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèª
                if (!player.instrument) {
                    return "âŒ ã‚µãƒ³ãƒ—ãƒ©ãƒ¼ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“";
                }
                if (!player.score) {
                    return "âŒ æ¥½è­œãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“";
                }
                return null; // å•é¡Œãªã—
            }

            checkPlayers() { // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹ã‚’å€‹åˆ¥ã«ç¢ºèª
                const errors = [];
                for (let i = 0; i < this.players.length; i++) {
                    const message = this.checkPlayer(this.players[i]);
                    if (message) {
                        errors.push(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${i + 1}: ${message}`);
                    }
                }
                return errors.length > 0 ? errors : null;
            }

            // å¿…è¦ã§ã‚ã‚Œã°ã€å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹ã‚’ã¾ã¨ã‚ã¦ç¢ºèªã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
            checkAllPlayers() {
                return this.players.every(player => player.instrument && player.score);
            }

            /**
             * ã™ã¹ã¦ã® Player ã®éŸ³é‡è¨­å®š
             * @param {number} volume - è¨­å®šã™ã‚‹éŸ³é‡ï¼ˆdBï¼‰
             */
            setVolume(volume) {
                this.players.forEach(player => player.setVolume(volume));
                console.log(`ğŸ”Š ã™ã¹ã¦ã® Player ã®éŸ³é‡ã‚’ ${volume} dB ã«è¨­å®šã—ã¾ã—ãŸ,  " ( class: MultiPlayer )"`);
            }

            /**
             * ã™ã¹ã¦ã® Player ã®ãƒ†ãƒ³ãƒè¨­å®š
             * @param {number} bpm - è¨­å®šã™ã‚‹ BPM
             */
            setTempo(bpm) {
                this.players.forEach(player => player.setTempo(bpm));
                console.log(`ğŸµ ã™ã¹ã¦ã® Player ã®ãƒ†ãƒ³ãƒã‚’ ${bpm} BPM ã«è¨­å®šã—ã¾ã—ãŸ`, " ( class: MultiPlayer )");
            }

            /**
             * ã™ã¹ã¦ã® Player ã«ç§»èª¿ã‚’é©ç”¨
             * @param {number} semitones - ç§»èª¿ã™ã‚‹åŠéŸ³æ•°
             */
            setTranspose(semitones) {
                this.players.forEach(player => player.setTranspose(semitones));
                console.log(`ğŸ¼ ã™ã¹ã¦ã® Player ã«ç§»èª¿ã‚’ ${semitones} åŠéŸ³é©ç”¨ã—ã¾ã—ãŸ`, " ( class: MultiPlayer )");
            }

            /**
             * ã™ã¹ã¦ã® Player ã«ãƒ«ãƒ¼ãƒ—è¨­å®šã‚’é©ç”¨
             * @param {boolean} isLoop - ãƒ«ãƒ¼ãƒ—å†ç”Ÿã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‹
             */
            setLoop(isLoop) {
                this.players.forEach(player => player.enableLoop(isLoop));
                console.log(`ğŸ”„ ã™ã¹ã¦ã® Player ã®ãƒ«ãƒ¼ãƒ—ã‚’ ${isLoop ? "ON" : "OFF"} ã«ã—ã¾ã—ãŸ`, " ( class: MultiPlayer )");
            }

            /**
             * ã™ã¹ã¦ã® Player ã«ã‚¹ã‚³ã‚¢ã‚’é©ç”¨
             * @param {object} scoreData - æ¥½è­œãƒ‡ãƒ¼ã‚¿
             */
            setScore(scoreData) {
                /*  TODO:
                setScore() ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ã¯ã€ã‚‚ã†å°‘ã—è©³ç´°ã«ã™ã‚‹ã¨è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
                ä¾‹ãˆã°ã€scoreData.parts ã®é•·ã•ãŒ this.players ã®é•·ã•ã‚ˆã‚ŠçŸ­ã„å ´åˆã«ã€
                ã©ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚¹ã‚³ã‚¢ãŒè¨­å®šã•ã‚Œãªã‹ã£ãŸã®ã‹ã‚’å…·ä½“çš„ã«ç¤ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚
                */
                if (!scoreData || !Array.isArray(scoreData.parts)) {
                    console.error("âš ï¸ ç„¡åŠ¹ãªã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿: `parts` ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", " ( class: MultiPlayer )");
                    return;
                }

                this.players.forEach((player, index) => {
                    if (index < scoreData.parts.length) {
                        player.setScore(scoreData, index);
                        console.log(`ğŸ¼ Player ${index + 1} ã«ã‚¹ã‚³ã‚¢ã‚’è¨­å®šã•ã›ã¾ã—ãŸ`, " ( class: MultiPlayer )");
                    } else {
                        console.warn(`âš ï¸ Player ${index + 1} ã«å‰²ã‚Šå½“ã¦ã‚‹ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“`, " ( class: MultiPlayer )");
                    }
                });

                if (this.players.length > scoreData.parts.length) {
                    console.warn("âš ï¸ ä¸€éƒ¨ã® Player ã«ã‚¹ã‚³ã‚¢ãŒè¨­å®šã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ", " ( class: MultiPlayer )");
                }
            }

            /**
                 * ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸­ã§ã€æœ€ã‚‚é•·ã„æ¼”å¥æ™‚é–“ã‚’å–å¾—ã™ã‚‹ã€‚
                  * â€»å„ Player ã®ã‚¹ã‚³ã‚¢ã®çµ‚äº†æ™‚åˆ»ï¼ˆtime + durationï¼‰ã‚’å‚è€ƒã«è¨ˆç®—ã™ã‚‹
                 * @returns {number} æœ€é•·æ¼”å¥æ™‚é–“ï¼ˆç§’ï¼‰ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™ã€‚
                 */
            getMaxPerformanceTime() {
                /*TODO:  
                    getMaxPerformanceTime() ã®è¨ˆç®—æ–¹æ³•
                    getMaxPerformanceTime() ã®è¨ˆç®—æ–¹æ³•ã§ã™ãŒã€ç¾åœ¨ã®å®Ÿè£…ã§ã¯ã€å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æœ€å¾Œã®éŸ³ç¬¦ã®çµ‚äº†æ™‚åˆ»ã‚’æ¯”è¼ƒã—ã¦ã„ã¾ã™ã€‚ã‚‚ã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é€”ä¸­ã«ä¼‘ç¬¦ãŒã‚ã‚‹å ´åˆã€ä¼‘ç¬¦ã®å¾Œã®éŸ³ç¬¦ã®é–‹å§‹æ™‚åˆ»ãŒè€ƒæ…®ã•ã‚Œã¾ã›ã‚“ã€‚
                    
                    ã‚ˆã‚Šæ­£ç¢ºãªæœ€é•·æ¼”å¥æ™‚é–“ã‚’è¨ˆç®—ã™ã‚‹ãŸã‚ã«ã¯ã€ã™ã¹ã¦ã®éŸ³ç¬¦ã®çµ‚äº†æ™‚åˆ»ã‚’æ¯”è¼ƒã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
                 */
                if (this.players.length === 0) {
                    return 0;
                }

                let maxTime = 0;
                this.players.forEach(player => {
                    if (player.score && player.score.length > 0) {
                        const lastNote = player.score[player.score.length - 1];
                        const playerEndTime = lastNote.time + lastNote.duration;
                        maxTime = Math.max(maxTime, playerEndTime);
                    }
                });
                return maxTime;
            }

            /**
             * ã™ã¹ã¦ã® Player ã®å†ç”Ÿé–‹å§‹
             * â€»ã“ã“ã§ Tone.Transport ã®é–‹å§‹ã‚„åœæ­¢ã‚¿ã‚¤ãƒãƒ¼ã®è¨­å®šã‚’ä¸€å…ƒç®¡ç†ã™ã‚‹
             */
            start() {
                if (this.players.length === 0) {
                    console.warn("âš ï¸ å†ç”Ÿã™ã‚‹ Player ãŒã‚ã‚Šã¾ã›ã‚“", " ( class: MultiPlayer )");
                    return;
                }

                if (!this.checkAllPlayers()) {
                    const errors = this.checkPlayers();
                    if (errors) {
                        console.error("âŒ å†ç”Ÿæº–å‚™ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚\n" + errors.join("\n"), " ( class: MultiPlayer )");
                    } else {
                        console.error("âŒ å†ç”Ÿæº–å‚™ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã™ã¹ã¦ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚µãƒ³ãƒ—ãƒ©ãƒ¼ã¨æ¥½è­œã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚", " ( class: MultiPlayer )");
                    }
                    return;
                }

                // â˜… Transport ã®é–‹å§‹å‰ã«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãŠã â˜…
                Tone.Transport.position = 0;

                // å„ Player ã® start() ã‚’å‘¼ã¶ï¼ˆPlayer å†…ã¯ Tone.Part ã®ç”Ÿæˆã®ã¿ï¼‰
                this.players.forEach(player => player.start());

                // å…¨ä½“ã®åœæ­¢ã‚¿ã‚¤ãƒãƒ¼ã‚’ MultiPlayer å´ã§è¨­å®šã™ã‚‹
                const maxPerformanceTime = this.getMaxPerformanceTime();
                console.log("æœ€é•·æ¼”å¥æ™‚é–“:", maxPerformanceTime);
                Tone.Transport.scheduleOnce(() => {
                    this.stop();
                    console.log("â¹ï¸ æ¼”å¥ãŒçµ‚äº†ã—ã¾ã—ãŸ", " ( class: MultiPlayer )");
                }, maxPerformanceTime);

                // â˜… Transport ã‚’é–‹å§‹ã™ã‚‹å‰ã«ã€AudioContext ã®çŠ¶æ…‹ãŒ running ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª â˜…
                Tone.Transport.start();

                console.log(`â–¶ï¸ ã™ã¹ã¦ã® Player ã®å†ç”Ÿã‚’é–‹å§‹ã—ã¾ã—ãŸ`, " ( class: MultiPlayer )");
                this.dispatchEvent(new Event(EVENT_PLAY));
            }

            /**
             * ã™ã¹ã¦ã® Player ã®å†ç”Ÿåœæ­¢
             * â€»å„ Player ã®åœæ­¢ã¨ Tone.Transport ã®åœæ­¢ã€å†ç”Ÿä½ç½®ã®ãƒªã‚»ãƒƒãƒˆã‚’è¡Œã†
             */
            stop() {
                this.players.forEach(player => player.stop());
                Tone.Transport.stop();
                Tone.Transport.position = 0;
                console.log("â¹ï¸ ã™ã¹ã¦ã® Player ã®å†ç”Ÿã‚’åœæ­¢ã—ã¾ã—ãŸ", " ( class: MultiPlayer )");
                this.dispatchEvent(new Event(EVENT_STOP));
            }

        }

        // ==================================================
        // 5. ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã‚¯ãƒ©ã‚¹ã®å®šç¾©
        // ==================================================

        /**
         * DataStore ã‚¯ãƒ©ã‚¹
         * æ±ç”¨ã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨åŸºåº•ã‚¯ãƒ©ã‚¹
         */
        class DataStore {
            constructor() {
                this.data = new Map(); // ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹ Map
            }

            /**
             * ãƒ‡ãƒ¼ã‚¿ã®ç™»éŒ²
             * @param {string} id - ä¸€æ„ã®è­˜åˆ¥å­
             * @param {any} data - ç™»éŒ²ã™ã‚‹ãƒ‡ãƒ¼ã‚¿
             */
            add(id, data) {
                if (!this.validate(data)) {
                    console.error(`âŒ ãƒ‡ãƒ¼ã‚¿ç™»éŒ²å¤±æ•—: ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿ (${id})`, " ( class: DataStore )");
                    return;
                }
                if (this.data.has(id)) {
                    console.error(`âŒ ç™»éŒ²å¤±æ•—: ID '${id}' ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™`, " ( class: DataStore )");
                    return;
                }
                this.data.set(id, data);
                console.log(`âœ… ãƒ‡ãƒ¼ã‚¿ç™»éŒ²: ${id}`, " ( class: DataStore )");
            }

            /**
             * ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
             * @param {string} id - å‰Šé™¤ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ID
             */
            remove(id) {
                if (this.data.has(id)) {
                    this.data.delete(id);
                    console.log(`ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤: ${id}`, " ( class: DataStore )");
                } else {
                    console.warn(`âš ï¸ å‰Šé™¤å¤±æ•—: ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“ (${id})`, " ( class: DataStore )");
                }
            }

            /**
             * ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
             * @param {string} id - å–å¾—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ID
             * @returns {any|null} - å­˜åœ¨ã™ã‚Œã°ãƒ‡ãƒ¼ã‚¿ã€ãªã‘ã‚Œã° null
             */
            get(id) {
                if (!this.data.has(id)) {
                    console.warn(`âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${id}`, " ( class: DataStore )");
                    return null;
                }
                return this.data.get(id);
            }

            /**
             * ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚µãƒ–ã‚¯ãƒ©ã‚¹ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã“ã¨ï¼‰
             */
            validate(data) {
                throw new Error("âŒ `validate()` ã¯ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã§å¿…ãšã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦ãã ã•ã„", " ( class: DataStore )");
            }
        }


        // MetaDataStore ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¦ã€validate() ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
        class MetaDataStore extends DataStore {
            /**
             * ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
             * ä»Šå›ã¯å˜ç´”ã« true ã‚’è¿”ã—ã¦å¸¸ã«æœ‰åŠ¹ã¨ã™ã‚‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦å‹ãƒã‚§ãƒƒã‚¯ãªã©ã‚’è¿½åŠ ã§ãã¾ã™ï¼‰
             * @param {any} data - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿
             * @returns {boolean} å¸¸ã« true
             */
            validate(data) {
                return true;
            }
        }

        /**
         * DictationScoreDataStore ã‚¯ãƒ©ã‚¹
         * æ¥½è­œãƒ‡ãƒ¼ã‚¿å°‚ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢
         */
        class DictationScoreDataStore extends DataStore {
            constructor() {
                super();
            }
            /**
             * æ¥½è­œãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ 
             * @param {string} id - ã‚¹ã‚³ã‚¢ã®ä¸€æ„è­˜åˆ¥å­
             * @param {object} scoreData - æ¥½è­œãƒ‡ãƒ¼ã‚¿
             */
            addScore(id, scoreData) {
                this.add(id, scoreData);
            }

            /**
             * æ¥½è­œãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
             * @param {string} id - ã‚¹ã‚³ã‚¢ã®ä¸€æ„è­˜åˆ¥å­
             */
            removeScore(id) {
                this.remove(id);
            }

            /**
             * æ¥½è­œãƒ‡ãƒ¼ã‚¿ã®å–å¾—
             * @param {string} id - ã‚¹ã‚³ã‚¢ã®ä¸€æ„è­˜åˆ¥å­
             * @returns {object|null} - æ¥½è­œãƒ‡ãƒ¼ã‚¿
             */
            getScore(id) {
                return this.get(id);
            }

            /**
             * ç‰¹å®šã®å°ç¯€ã‚’æŠ½å‡º
             * @param {string} id - ã‚¹ã‚³ã‚¢ã®ä¸€æ„è­˜åˆ¥å­
             * @param {number} startBar - é–‹å§‹å°ç¯€
             * @param {number} endBar - çµ‚äº†å°ç¯€
             */
            trimSection(id, startBar, endBar) {
                const score = this.get(id);
                if (!score || !Array.isArray(score.parts)) {
                    console.error("âš ï¸ ç„¡åŠ¹ãªã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿: `parts` ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", " ( class: DictationScoreDataStore )");
                    return;
                }

                score.parts.forEach(part => {
                    if (Array.isArray(part.notes)) {
                        part.notes = part.notes.filter(note =>
                            note.barNumber >= startBar && note.barNumber <= endBar
                        );
                    }
                });

                console.log(`âœ‚ï¸ ã‚¹ã‚³ã‚¢ '${id}' ã®å°ç¯€ ${startBar}-${endBar} ã‚’ãƒˆãƒªãƒŸãƒ³ã‚°ã—ã¾ã—ãŸ`, " ( class: DictationScoreDataStore )");
            }

            /**
             * ç„¡éŸ³æ™‚é–“ã‚’è¿½åŠ 
             * @param {string} id - ã‚¹ã‚³ã‚¢ã®ä¸€æ„è­˜åˆ¥å­
             * @param {number} durationSeconds - è¿½åŠ ã™ã‚‹ç„¡éŸ³ã®ç§’æ•°
             */
            generateSilence(id, durationSeconds) {
                const score = this.get(id);
                if (!score || !Array.isArray(score.parts)) {
                    console.error("âš ï¸ ç„¡åŠ¹ãªã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿: `parts` ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", " ( class: DictationScoreDataStore )");
                    return;
                }

                score.parts.forEach(part => {
                    if (!Array.isArray(part.notes) || part.notes.length === 0) {
                        console.warn("âš ï¸ ãƒ‘ãƒ¼ãƒˆã« `notes` ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ç„¡éŸ³è¿½åŠ ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ", " ( class: DictationScoreDataStore )");
                        return;
                    }

                    const lastBeat = Math.max(
                        ...part.notes.map(note => note.absoluteBeat + note.duration),
                        0
                    );

                    part.notes.push({
                        absoluteBeat: lastBeat,
                        barNumber: Math.ceil(lastBeat / (score.meta.timeSignature[0] * 480)),
                        pitch: null,
                        duration: durationSeconds * 480,
                        velocity: 0
                    });
                });

                console.log(`ğŸ”‡ ã‚¹ã‚³ã‚¢ '${id}' ã« ${durationSeconds} ç§’ã®ç„¡éŸ³ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, " ( class: DictationScoreDataStore )");
            }

            /**
             * è¤‡æ•°ã®ã‚¹ã‚³ã‚¢ã‚’çµåˆ
             * @param {string} id - çµåˆå¾Œã®ã‚¹ã‚³ã‚¢ID
             * @param {...string} scoreIds - çµåˆã™ã‚‹ã‚¹ã‚³ã‚¢ã®IDãƒªã‚¹ãƒˆ
             */
            mergeScores(id, ...scoreIds) {
                const mergedScore = {
                    meta: { ...this.get(scoreIds[0]).meta },
                    parts: []
                };

                scoreIds.forEach(scoreId => {
                    const score = this.get(scoreId);
                    if (!score) return;

                    score.parts.forEach((part, index) => {
                        if (!mergedScore.parts[index]) {
                            mergedScore.parts[index] = { part: index + 1, partName: part.partName, notes: [] };
                        }
                        mergedScore.parts[index].notes.push(...part.notes);
                    });
                });

                this.addScore(id, mergedScore);
                console.log(`ğŸ”€ ã‚¹ã‚³ã‚¢ '${scoreIds.join(", ")}' ã‚’çµåˆã—ã¦ '${id}' ã«ä¿å­˜ã—ã¾ã—ãŸ`, " ( class: DictationScoreDataStore )");
            }

            /**
             * æ¥½è­œãƒ‡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
             * @param {object} scoreData - æ¥½è­œãƒ‡ãƒ¼ã‚¿
             * @returns {boolean} - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœ
             */
            validate(scoreData) {
                const schema = {
                    meta: { required: false, isOfType: "object" },
                    parts: { required: true, isArray: true },
                    "meta.title": { required: false, isOfType: "string" },
                    "meta.bpm": { required: false, isOfType: "number", min: 40, max: 240 },
                    "meta.timeSignature": { required: false, isArray: true },
                    "meta.baseKey": { required: false, isOfType: "string" },
                    "parts[].notes": { required: true, isArray: true }
                };


                const { isValid, errors } = validateSchema(scoreData, schema);

                if (!isValid) {
                    console.error("âŒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:", " ( class: DictationScoreDataStore )");
                    errors.forEach(error => {
                        console.error(`- ${error.key}: ${error.message}`, " ( class: DictationScoreDataStore )");
                    });
                    console.log(" ãƒã‚§ãƒƒã‚¯ã—ãŸã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿: ", JSON.stringify(scoreData, null, 2), " ( class: DictationScoreDataStore )");
                }
                return isValid;
            }
        }

        // ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç”Ÿæˆã¨åˆæœŸãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ 
        //const scoreStore = new DictationScoreDataStore();
        //scoreStore.addScore("sample1", scoreData1);

        /**
         * InstrumentDataStore ã‚¯ãƒ©ã‚¹
         * æ¥½å™¨ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†ãŠã‚ˆã³ Tone.js æ¥½å™¨ã®ãƒ­ãƒ¼ãƒ‰ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¡Œã†
         */
        class InstrumentDataStore extends DataStore {
            constructor() {
                super();
                this.instrumentCache = new Map(); // ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿æ¥½å™¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
            }

            /**
             * æ¥½å™¨ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ 
             * @param {string} id - æ¥½å™¨ã®ä¸€æ„è­˜åˆ¥å­
             * @param {object} instrumentData - æ¥½å™¨ãƒ‡ãƒ¼ã‚¿
             */
            addInstrument(id, instrumentData) {
                this.add(id, instrumentData);
            }

            /**
             * æ¥½å™¨ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
             * @param {string} id - æ¥½å™¨ã®ä¸€æ„è­˜åˆ¥å­
             */
            removeInstrument(id) {
                this.remove(id);
                this.instrumentCache.delete(id);
            }

            /**
             * æ¥½å™¨ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
             * @param {string} id - æ¥½å™¨ã®ä¸€æ„è­˜åˆ¥å­
             * @returns {object|null} - æ¥½å™¨ãƒ‡ãƒ¼ã‚¿
             */
            getInstrument(id) {
                return this.get(id);
            }

            /**
             * Tone.js æ¥½å™¨ã®ãƒ­ãƒ¼ãƒ‰
             * @param {string} id - æ¥½å™¨ã®ä¸€æ„è­˜åˆ¥å­
             * @returns {Promise<Tone.Sampler | Tone.Synth>}
             */
            async loadInstrument(id) {
                const instrumentData = this.getInstrument(id);
                if (!instrumentData) {
                    console.error(`âŒ æ¥½å™¨ '${id}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, " ( class: InstrumentDataStore )");
                    return null;
                }

                // ã‚·ãƒ³ã‚»ã®å ´åˆã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã‚ãšæ¯å›æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
                if (instrumentData.type === "synth") {
                    console.log(`ğŸ¹ æ–°ã—ã„ã‚·ãƒ³ã‚»ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ (${id})`, " ( class: InstrumentDataStore )");
                    const synth = new Tone.Synth(instrumentData.config).toDestination();
                    return synth;
                }

                // samplerï¼ˆä¾‹ï¼šãƒ”ã‚¢ãƒï¼‰ã®å ´åˆã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨
                if (this.instrumentCache.has(id)) {
                    console.log(`ğŸ¹ æ¥½å™¨ '${id}' ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ã§ã™`, " ( class: InstrumentDataStore )");
                    return this.instrumentCache.get(id);
                }

                if (instrumentData.type === "sampler") {
                    const sampler = new Tone.Sampler({
                        urls: instrumentData.samples,
                        baseUrl: instrumentData.baseUrl
                    }).toDestination();
                    this.instrumentCache.set(id, sampler);
                    return sampler;
                }

                console.error(`âŒ æœªçŸ¥ã®æ¥½å™¨ã‚¿ã‚¤ãƒ— '${instrumentData.type}'`, " ( class: InstrumentDataStore )");
                return null;
            }


            /**
             * æ¥½å™¨ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
             * @param {string} id - æ¥½å™¨ã®ä¸€æ„è­˜åˆ¥å­
             */
            cacheInstrument(id) {
                if (this.instrumentCache.has(id)) {
                    console.log(`ğŸ›ï¸ æ¥½å™¨ '${id}' ã¯ã™ã§ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿`, " ( class: InstrumentDataStore )");
                    return;
                }

                this.loadInstrument(id).then((instrument) => {
                    if (instrument) {
                        this.instrumentCache.set(id, instrument);
                        console.log(`âœ… æ¥½å™¨ '${id}' ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ`, " ( class: InstrumentDataStore )");
                    }
                }).catch((error) => {
                    console.error(`âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å¤±æ•—:`, error, " ( class: InstrumentDataStore )");
                });
            }

            /**
             * æ¥½å™¨ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
             * @param {object} instrumentData - æ¥½å™¨ãƒ‡ãƒ¼ã‚¿
             * @returns {boolean} - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœ
             */
            validate(instrumentData) {
                const schema = {
                    name: { required: true, isOfType: "string" },
                    type: { required: true, isOfType: "string" },
                    samples: { required: false, isOfType: "object" },
                    baseUrl: { required: false, isOfType: "string" },
                    config: { required: false, isOfType: "object" }
                };

                const { isValid, errors } = validateSchema(instrumentData, schema);

                if (!isValid) {
                    console.error("âŒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:", errors, " ( class: InstrumentDataStore )");
                }

                return isValid;
            }
        }














        // ==================================================
        // 6. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç”Ÿæˆã¨ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        // ==================================================
        // TODO: defaultSynthã¯æ¯å›ä½¿ã†ã®ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–
        const defaultSynth = {
            name: "ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼",
            type: "synth",
            config: {
                oscillator: {
                    type: "sine"  // ã‚µã‚¤ãƒ³æ³¢ã§æŸ”ã‚‰ã‹ãªéŸ³è‰²ã‚’ä½œæˆ
                },
                envelope: {
                    attack: 0.005,   // éå¸¸ã«çŸ­ã„ã‚¢ã‚¿ãƒƒã‚¯
                    decay: 0.3,      // é©åº¦ãªãƒ‡ã‚£ã‚±ã‚¤
                    sustain: 0.5,    // æŒç¶šãƒ¬ãƒ™ãƒ«
                    release: 1.2     // ã‚†ã£ãã‚Šã¨ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
                },
                filter: {
                    Q: 1,            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å…±é³´
                    type: "lowpass",
                    rolloff: -12     // 12dB/oct ã®ãƒ­ãƒ¼ãƒ«ã‚ªãƒ•
                }
            }
        };

        // TODO: defaultSamplerã¯æ¯å›ä½¿ã†ã®ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–
        const defaultSampler = {
            name: "ãƒ”ã‚¢ãƒ",
            type: "sampler",
            samples: {
                A0: "A0.mp3", C1: "C1.mp3", "D#1": "Ds1.mp3", "F#1": "Fs1.mp3",
                A1: "A1.mp3", C2: "C2.mp3", "D#2": "Ds2.mp3", "F#2": "Fs2.mp3",
                A2: "A2.mp3", C3: "C3.mp3", "D#3": "Ds3.mp3", "F#3": "Fs3.mp3",
                A3: "A3.mp3", C4: "C4.mp3", "D#4": "Ds4.mp3", "F#4": "Fs4.mp3",
                A4: "A4.mp3", C5: "C5.mp3", "D#5": "Ds5.mp3", "F#5": "Fs5.mp3",
                A5: "A5.mp3", C6: "C6.mp3", "D#6": "Ds6.mp3", "F#6": "Fs6.mp3",
                A6: "A6.mp3", C7: "C7.mp3", "D#7": "Ds7.mp3", "F#7": "Fs7.mp3",
                A7: "A7.mp3", C8: "C8.mp3"
            },
            baseUrl: "https://tonejs.github.io/audio/salamander/"

        };

        const scoreMeta = {
            id: 1,
            title: "è´éŸ³èª²é¡Œã‚µãƒ³ãƒ—ãƒ«",
            composer: "H. K.",
            bpm: 80,
            timeSignature: [4, 4],
            baseKey: "C",
            hearingType: "è¤‡æ—‹å¾‹",
            level: 1,
            tags: ["è´éŸ³", "è¤‡æ—‹å¾‹", "ã‚½ãƒ—ãƒ©ãƒ", "ãƒã‚¹"]
        };

        const scoreParts01 = {
            "meta": scoreMeta,
            "parts": [
                {
                    "part": 1,
                    "partName": "ã‚½ãƒ—ãƒ©ãƒ",
                    "notes": [
                        { "absoluteBeat": 0.000, "barNumber": 1, "pitch": "C4", "duration": 480, "velocity": 0.80 },
                        { "absoluteBeat": 1.000, "barNumber": 1, "pitch": "D4", "duration": 160, "velocity": 0.80 },
                        { "absoluteBeat": 1.333, "barNumber": 1, "pitch": "E4", "duration": 160, "velocity": 0.80 },
                        { "absoluteBeat": 1.667, "barNumber": 1, "pitch": "F4", "duration": 160, "velocity": 0.80 },
                        { "absoluteBeat": 2.000, "barNumber": 1, "pitch": "G4", "duration": 480, "velocity": 0.80 },
                        { "absoluteBeat": 3.000, "barNumber": 1, "pitch": "A4", "duration": 320, "velocity": 0.80 },
                        { "absoluteBeat": 3.667, "barNumber": 1, "pitch": "B4", "duration": 160, "velocity": 0.80 }
                    ]
                },
                {
                    "part": 2,
                    "partName": "ãƒã‚¹",
                    "notes": [
                        { "absoluteBeat": 0.000, "barNumber": 1, "pitch": "E3", "duration": 1920, "velocity": 0.80 },
                        { "absoluteBeat": 1.000, "barNumber": 1, "pitch": "C3", "duration": 1920, "velocity": 0.80 }
                    ]
                }
            ]
        };

        const scoreParts02 = {
            "meta": scoreMeta,
            "parts": [
                {
                    "part": 1,
                    "partName": "ã‚½ãƒ—ãƒ©ãƒ",
                    "notes": [
                        { "absoluteBeat": 0.000, "barNumber": 1, "pitch": "C5", "duration": 480, "velocity": 0.80 },
                        { "absoluteBeat": 1.000, "barNumber": 1, "pitch": "D5", "duration": 160, "velocity": 0.80 },
                        { "absoluteBeat": 1.333, "barNumber": 1, "pitch": "E5", "duration": 160, "velocity": 0.80 },
                        { "absoluteBeat": 1.667, "barNumber": 1, "pitch": "F5", "duration": 160, "velocity": 0.80 },
                        { "absoluteBeat": 2.000, "barNumber": 1, "pitch": "G5", "duration": 480, "velocity": 0.80 },
                        { "absoluteBeat": 3.000, "barNumber": 1, "pitch": "A5", "duration": 320, "velocity": 0.80 },
                        { "absoluteBeat": 3.667, "barNumber": 1, "pitch": "B5", "duration": 160, "velocity": 0.80 }
                    ]
                },
                {
                    "part": 2,
                    "partName": "ãƒã‚¹",
                    "notes": [
                        { "absoluteBeat": 0.000, "barNumber": 1, "pitch": "E3", "duration": 1920, "velocity": 0.80 },
                        { "absoluteBeat": 1.000, "barNumber": 1, "pitch": "C3", "duration": 1920, "velocity": 0.80 }
                    ]
                }
            ]
        }

        const scorePartsExam = {
            "meta": scoreMeta,
            "parts": [
                {
                    "part": 1,
                    "partName": "ã‚½ãƒ—ãƒ©ãƒ",
                    "notes": [
                        { "absoluteBeat": 0.000, "barNumber": 1, "pitch": "C6", "duration": 480, "velocity": 0.80 },
                        { "absoluteBeat": 1.000, "barNumber": 1, "pitch": "D6", "duration": 160, "velocity": 0.80 },
                        { "absoluteBeat": 1.333, "barNumber": 1, "pitch": "E6", "duration": 160, "velocity": 0.80 },
                        { "absoluteBeat": 1.667, "barNumber": 1, "pitch": "F6", "duration": 160, "velocity": 0.80 },
                        { "absoluteBeat": 2.000, "barNumber": 1, "pitch": "G6", "duration": 480, "velocity": 0.80 },
                        { "absoluteBeat": 3.000, "barNumber": 1, "pitch": "A6", "duration": 320, "velocity": 0.80 },
                        { "absoluteBeat": 3.667, "barNumber": 1, "pitch": "B6", "duration": 160, "velocity": 0.80 }
                    ]
                },
                {
                    "part": 2,
                    "partName": "ãƒã‚¹",
                    "notes": [
                        { "absoluteBeat": 0.000, "barNumber": 1, "pitch": "E3", "duration": 1920, "velocity": 0.80 },
                        { "absoluteBeat": 1.000, "barNumber": 1, "pitch": "C3", "duration": 1920, "velocity": 0.80 }
                    ]
                }
            ]
        }

        // ----------------------------------------
        // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
        // ----------------------------------------
        // æ¥½å™¨ãƒ‡ãƒ¼ã‚¿
        const instrumentStore = new InstrumentDataStore();
        // â˜… ã¾ãšæ¥½å™¨ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¦ã‹ã‚‰ Player ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹ â˜…
        instrumentStore.addInstrument("synth", defaultSynth);
        instrumentStore.addInstrument("piano", defaultSampler);

        // æ¥½è­œãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ»æ¥½è­œãƒ‡ãƒ¼ã‚¿ã®ç™»éŒ²
        const scoreMetaStore = new MetaDataStore();
        const scoreStore = new DictationScoreDataStore();
        scoreMetaStore.add("scoreMeta", scoreMeta);
        scoreStore.addScore("sample1", {
            "meta": scoreMetaStore.get("scoreMeta"),
            "parts": scoreParts01.parts
        });
        scoreStore.addScore("sample2", {
            "meta": scoreMetaStore.get("scoreMeta"),
            "parts": scoreParts02.parts
        });
        scoreStore.addScore("exam", {
            "meta": scoreMetaStore.get("scoreMeta"),
            "parts": scorePartsExam.parts
        });

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç™»éŒ²
        let multiPlayer = new MultiPlayer(); // è¤‡æ•°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç®¡ç†ã™ã‚‹ MultiPlayer ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç”Ÿæˆ
        const sopranoPlayer = new Player();  // ã‚½ãƒ—ãƒ©ãƒç”¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚µãƒ³ãƒ—ãƒ©ãƒ¼ï¼‰
        const bassPlayer = new Player();    // ãƒã‚¹ç”¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚µãƒ³ãƒ—ãƒ©ãƒ¼ï¼‰
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¿½åŠ 
        multiPlayer.addPlayer(sopranoPlayer);
        multiPlayer.addPlayer(bassPlayer);





        // æ¥½è­œã‚’è¨­å®š
        const selectedScore = scoreStore.getScore(scoreSelect.value);
        if (selectedScore && selectedScore.parts.length >= 2) {
            multiPlayer.setScore(selectedScore);
            console.log(" ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°ã—ã¾ã—ãŸ:", scoreSelect.value);
        } else {
            console.error("âš ï¸ ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã§ã™:", selectedScore);
        }

        // æº–å‚™å®Œäº†ã—ãŸã‹ç¢ºèª
        function checkMultiPlayerReady() {
            if (multiPlayer.isReady()) {
                console.log("checkMultiPlayerReady true");
                updateStatus(STATUS_MSG_READY);
                // å†ç”Ÿé–‹å§‹å‡¦ç†ãªã©
            } else {
                console.log("checkMultiPlayerReady false");
                updateStatus(STATUS_MSG_PREPARING);
                // 1ç§’å¾Œã«å†åº¦ãƒã‚§ãƒƒã‚¯
                setTimeout(checkMultiPlayerReady, 1000);
            }
        }
        checkMultiPlayerReady();

        // ãƒ†ãƒ³ãƒã€éŸ³é‡ã€ç§»èª¿ã€ãƒ«ãƒ¼ãƒ—å†ç”Ÿã®åˆæœŸåŒ–
        multiPlayer.setTempo(scoreMeta.bpm);
        bpmControl.value = scoreMeta.bpm;
        bpmValue.value = scoreMeta.bpm;
        multiPlayer.setVolume(0);
        volumeControl.value = 0;
        volumeValue.value = 0;
        multiPlayer.setTranspose(0);
        transposeControl.value = 0;
        //multiPlayer.setLoop();


        // ==================================================
        // 7. ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã¨åˆæœŸUIè¨­å®š
        // ==================================================
        // MultiPlayer ã®å†ç”Ÿã‚¤ãƒ™ãƒ³ãƒˆ: ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
        multiPlayer.addEventListener("play", () => {
            console.log("â–¶ï¸ å†ç”Ÿé–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚Šã¾ã—ãŸ");
            togglePlayButtons(false);
            updateStatus(STATUS_MSG_PLAYING);
        });

        multiPlayer.addEventListener("stop", () => {
            console.log("â¹ï¸ åœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚Šã¾ã—ãŸ");
            togglePlayButtons(true);
            updateStatus(STATUS_MSG_STOPPED);
        });

        // ã‚½ãƒ—ãƒ©ãƒã®æ¥½å™¨å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ: æ¥½å™¨ãŒå¤‰æ›´ã•ã‚ŒãŸéš›ã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›
        sopranoPlayer.addEventListener("instrumentChange", () => {
            console.log("ğŸ¹ ã‚½ãƒ—ãƒ©ãƒã®æ¥½å™¨ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ:", sopranoPlayer.currentInstrumentKey);
        });

        // ãƒã‚¹ã®æ¥½å™¨å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ: æ¥½å™¨ãŒå¤‰æ›´ã•ã‚ŒãŸéš›ã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›
        bassPlayer.addEventListener("instrumentChange", () => {
            console.log("ğŸ¹ ãƒã‚¹ã®æ¥½å™¨ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ:", bassPlayer.currentInstrumentKey);
        });

        // æ¥½å™¨å¤‰æ›´ã®å…±é€šå‡¦ç†ã‚’è¡Œã†éåŒæœŸé–¢æ•°
        async function handleInstrumentChange(player, event) {
            const selectedInstrument = event.target.value;

            // instrumentStore ã‹ã‚‰æ¥½å™¨ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦è¨­å®š
            const instrument = await instrumentStore.loadInstrument(selectedInstrument);

            // MultiPlayerçµŒç”±ã§æ¥½å™¨ã‚’è¨­å®š
            multiPlayer.players.forEach((player) => {
                player.instruments[selectedInstrument] = instrument;
                player.setInstrument(selectedInstrument);
            });

            console.log(`æ¥½å™¨ã‚’${selectedInstrument}ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
        }

        // ã‚½ãƒ—ãƒ©ãƒã®æ¥½å™¨å¤‰æ›´ãƒªã‚¹ãƒŠãƒ¼
        sopranoInstrument.addEventListener("change", async (event) => {
            await handleInstrumentChange(sopranoPlayer, event);
        });

        // ãƒã‚¹ã®æ¥½å™¨å¤‰æ›´ãƒªã‚¹ãƒŠãƒ¼
        bassInstrument.addEventListener("change", async (event) => {
            await handleInstrumentChange(bassPlayer, event);
        });

        // æ¥½è­œå¤‰æ›´æ™‚ã®å‡¦ç†
        scoreSelect.addEventListener("change", () => {
            const selectedScore = scoreStore.getScore(scoreSelect.value);
            if (selectedScore && selectedScore.parts.length >= 2) {
                togglePlayButtons(false);
                multiPlayer.setScore(selectedScore);
                console.log(" ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°ã—ã¾ã—ãŸ:", scoreSelect.value);
                togglePlayButtons(true);
                //updateStatus(STATUS_MSG_SCORE, scoreSelect.value);

            } else {
                console.error("âš ï¸ ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã§ã™:", selectedScore);
            }
        });


        // ==================================================
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // ==================================================
        function getElementsByIds(ids) {
            if (!Array.isArray(ids)) {
                ids = [ids];
            }

            const elements = {};
            ids.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    elements[id] = element;
                } else {
                    console.error(`Element with ID '${id}' not found.`);
                }
            });
            return ids.length === 1 ? elements[ids[0]] : elements;
        }

        // å–å¾—ã—ãŸã„è¦ç´ ã® id ã‚’é…åˆ—ã§æŒ‡å®š
        //const ids = ['header', 'content', 'footer'];
        // getElementsById é–¢æ•°ã‚’ä½¿ã£ã¦è¦ç´ ã‚’å–å¾—
        //const elements = getElementsById(ids);
        // å–å¾—ã—ãŸè¦ç´ ã«ã‚¢ã‚¯ã‚»ã‚¹
        //console.log(elements.header);
        //console.log(elements.content);
        //console.log(elements.footer);

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹
        function updateStatus(message, message2 = "") { // message2ã¯çœç•¥å¯èƒ½
            statusText.textContent = message + message2;
        }
        // ä¾‹ï¼šãƒ†ãƒ³ãƒã‚’å¤‰æ›´ã—ãŸå ´åˆ
        // const currentBpm = 120;
        // updateStatus(STATUS_MSG_BPM_CHANGING, currentBpm);
        // ä¾‹ï¼šæ¥½å™¨ã‚’å¤‰æ›´ã—ãŸå ´åˆï¼ˆè¿½åŠ æƒ…å ±ãªã—ï¼‰
        // updateStatus(STATUS_MSG_INSTRUMENT_CHANGING);


        function togglePlayButtons(isStartButton) {
            if (isStartButton) {
                // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æ´»æ€§åŒ–ã—ã€ã‚¹ãƒˆãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’ä¸æ´»æ€§åŒ–
                startBtn.classList.remove("disabled");
                stopBtn.classList.add("disabled");
            } else {
                // ã‚¹ãƒˆãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’æ´»æ€§åŒ–ã—ã€ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’ä¸æ´»æ€§åŒ–
                startBtn.classList.add("disabled");
                stopBtn.classList.remove("disabled");
            }
        }

    </script>

</body>

</html>